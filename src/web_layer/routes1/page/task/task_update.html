{% extends 'base_page.html' %}
{% block title %}
    舆情分析-更新任务
{% endblock %}


{% block content %}
    <!-- Dark overlay background -->
    <div class="modal-overlay" style="display: flex;">
        <!-- Modal container centered -->
        <div class="modal-container">
            <div class="modal-header">
                <h4 class="font-weight-bold">任务{{ task.task_id }}配置修改</h4>
                <a href="/page/task/home" class="close-modal">&times;</a>
            </div>
            <div class="modal-body">
                <form class="task-form" method="POST" id="task_update" action="/page/task/update">  
                    <input type="hidden" name="task_id" value="{{task.task_id}}">        

                    <div class="form-row">
                        <div class="form-group">
                            <label for="platform_name" class="form-label font-weight-bold text-muted text-uppercase">* 社交平台</label>
                            <select multiple class="form-control_window choicesjs" id="platform_name" name="platform_name">
                                <option {% if '小红书' in task.platform %}selected{% endif %}>小红书</option>
                                <option {% if '知乎' in task.platform %}selected{% endif %}>知乎</option>
                                <option {% if '哔哩哔哩' in task.platform %}selected{% endif %}>哔哩哔哩</option>
                                <option {% if '微博' in task.platform %}selected{% endif %}>微博</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div id="cookiesContainer" class="form-group">
                         
                        </div>
                    </div>

 
                    <div class="form-row">
                        <div class="form-group">
                            <label for="start_time" class="form-label font-weight-bold text-muted text-uppercase">评论开始时间</label>
                            <input type="date" class="form-control_window" id="start_time" name="start_time" 
                                   value="{{ task.start_time }}">
                        </div>
                        <div class="form-group">
                            <label for="end_time" class="form-label font-weight-bold text-muted text-uppercase">评论结束时间</label>
                            <input type="date" class="form-control_window" id="end_time" name="end_time" 
                                   value="{{ task.end_time }}">
                        </div>                                
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="agency_name" class="form-label font-weight-bold text-muted text-uppercase">* 医疗机构全称</label>
                            <input type="text" class="form-control_window" id="agency_name" name="agency_name" 
                                   placeholder="请输入医疗机构全称" value="{{ task.agency_name }}" required>
                        </div>
                        <div class="form-group">
                            <label for="other_names" class="form-label font-weight-bold text-muted text-uppercase">医疗机构简称/别名</label>
                            <input type="text" class="form-control_window" id="other_names" name="other_names" 
                                   placeholder="请输入医疗机构简称/别名，若有多个请用///进行分隔" value="{{ task.other_names }}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="max_note" class="form-label font-weight-bold text-muted text-uppercase">每个平台最大爬取帖子数</label>
                            <input type="number" class="form-control_window" id="max_note" name="max_note" placeholder="请输入1-1000之间的整数"
                                   value="{{ task.max_note }}">
                        </div>

                        <div class="form-group">
                            <label for="max_comment" class="form-label font-weight-bold text-muted text-uppercase">每个帖子最大爬取评论数</label>
                            <input type="number" class="form-control_window" id="max_comment" name="max_comment" 
                            placeholder="请输入1-500之间的整数" value="{{ task.max_comment }}">
                        </div>
                    </div>

                    <div class="form-row">
                        <label for="if_level" class="form-label font-weight-bold text-muted text-uppercase">是否爬取二级评论</label>
                        <select class="form-control" id="if_level" name="if_level">
                            <option value="" selected disabled>请选择</option>
                            <option {%if task.if_level == 0%}selected{% endif %}>否</option>
                            <option {%if task.if_level == 1%}selected{% endif %}>是</option>
                             </select>
                    </div> 

                    <div class="form-row">
                        <div class="form-group">
                            <label for="gpu" class="form-label font-weight-bold text-muted text-uppercase">运行GPU</label>
                            <input type="text" class="form-control_window" id="gpu" name="gpu" 
                                   placeholder="将gpu编号用英文逗号,进行分隔" value="{{ task.gpu }}">        
                        </div>
                        <div class="form-group">
                            <label for="batch_size" class="form-label font-weight-bold text-muted text-uppercase">推理批量大小</label>
                            <input type="text" class="form-control_window" id="batch_size" name="batch_size" placeholder="请输入推理批量大小" value="{{ task.batch_size }}">        
                        </div>
                    </div>

                    <div class="form-actions">
                        <a href="/page/task/home" class="btn btn-secondary">取消</a>
                        <button type="submit" class="btn btn-primary">提交</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script>
// 平台选择变化时动态显示对应的Cookies输入框
const platformSelect = document.getElementById('platform_name');
const cookiesContainer = document.getElementById('cookiesContainer');

// 平台与Cookie字段的映射
const platformCookiesMap = {
    '小红书': { name: 'cookies_xhs', placeholder: '小红书用户Cookies' },
    '知乎': { name: 'cookies_zhihu', placeholder: '知乎用户Cookies' },
    '哔哩哔哩': { name: 'cookies_bili', placeholder: '哔哩哔哩用户Cookies' },
    '微博': { name: 'cookies_wb', placeholder: '微博用户Cookies' }
};

// 监听平台选择变化
platformSelect.addEventListener('change', function() {
    updateCookieInputs();
});

// 初始化时也调用一次
updateCookieInputs();

function updateCookieInputs() {
    // 清空容器
    cookiesContainer.innerHTML = '';
    
    // 获取选中的平台
    const selectedPlatforms = Array.from(platformSelect.selectedOptions).map(opt => opt.value);
    
    // 如果没有选择任何平台，不显示任何输入框
    if (selectedPlatforms.length === 0) {
        return;
    }
    
    // 创建label
    const label = document.createElement('label');
    label.textContent = '平台Cookies';
    cookiesContainer.appendChild(label);
    
    // 为每个选中的平台创建输入框
    selectedPlatforms.forEach(platform => {
        if (platformCookiesMap[platform]) {
            const inputGroup = document.createElement('div');
            inputGroup.className = 'cookie-input-group';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.value= ''
            input.className = 'form-control_window';
            input.name = platformCookiesMap[platform].name;
            input.placeholder = platformCookiesMap[platform].placeholder;
            
            inputGroup.appendChild(input);
            cookiesContainer.appendChild(inputGroup);
        }
    });
}

// 处理表单提交
document.getElementById('task_update').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    try {
        const response = await fetch(this.action, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            window.location.href = result.redirect;
        } else {
            showErrorToast(result.message);
        }
    } catch (error) {
        showErrorToast('网络错误，请稍后再试');
    }
});
</script>
{% endblock %}

