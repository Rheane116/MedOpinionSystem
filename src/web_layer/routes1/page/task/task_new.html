{% extends 'base_page.html' %}
{% block title %}
    舆情分析
{% endblock %}


{% block content %}
    <div class="container-fluid">
        <div class="row">
            <div class="col-full">
                <div class="d-flex flex-wrap align-items-center justify-content-between my-schedule mb-4">
                   <div class="d-flex align-items-center justify-content-between">
                        <h4 class="font-weight-bold">舆情任务列表</h4>
                    </div>
                    <div class="create-workform">
                        <button id="newTaskBtn" class="btn btn-primary position-relative d-flex align-items-center justify-content-between">
                            <svg xmlns="http://www.w3.org/2000/svg" class="mr-2" width="20" fill="none" viewbox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            新建任务
                        </button>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-12">
                        <div class="card card-block card-stretch">
                            <div class="card-body p-0">
                                <div class="d-flex justify-content-between align-items-center p-3">
                                    <h5 class="font-weight-bold">任务列表</h5>
                                </div>

                                <div class="table-responsive">
                                    <table class="table data-table mb-0">
                                        <thead class="table-color-heading">
                                            <tr class="text-light">
                                                <th scope="col">
                                                    <label class="text-muted m-0">任务编号</label>
                                                </th>
                                                <th scope="col">
                                                    <label class="text-muted mb-0">医疗机构关键词</label>
                                                </th>
                                                <th scope="col">
                                                    <label class="text-muted mb-0">平台</label>
                                                </th>
                                                </th>
                                                <th scope="col">
                                                    <label class="text-muted mb-0">时间跨度</label>
                                                </th>                                                                                           
                                                <th scope="col">
                                                    <label class="text-muted mb-0">创建时间</label>
                                                </th>
                                                <th scope="col">
                                                    <label class="text-muted mb-0">任务状态</label>
                                                </th>
                                                <th scope="col">
                                                    <span class="text-muted">操作</span>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                {%set status_config = {
                                                    0:{'text':'待启动', 'fill':'#E79805', 'text_class':'warning'},
                                                    1:{'text':'爬取中', 'fill':'#BEBEBE', 'text_class':'light'},
                                                    2:{'text':'分析中', 'fill':'#BEBEBE', 'text_class':'light'},
                                                    3:{'text':'已完成', 'fill':'#3CB371', 'text_class':'success'},
                                                    4:{'text':'爬取失败', 'fill':'#CD5C5C', 'text_class':'danger'},
                                                    5:{'text':'分析失败', 'fill':'#CD5C5C', 'text_class':'danger'},
                                                }%}
                                                {% for task in tasks %}
                                                    <tr>
                                                        <td>{{ task.task_id }}</td>
                                                        <td>{{ task.agency_name }}</td>
                                                        <td>{{ task.platform }}</td>
                                                        <td>{{ task.start_time }} -> {{ task.end_time }}</td>
                                                        <td>{{ task.create_time }}</td>
                                                        <td>
                                                            <p class="mb-0 text-{{ status_config.get(task.status).text_class }} font-weight-bold d-flex justify-content-start align-items-center">
                                                                <small><svg class="mr-2" xmlns="http://www.w3.org/2000/svg" width="18" viewbox="0 0 24 24" fill="none">
                                                                <circle cx="12" cy="12" r="8" fill="{{ status_config.get(task.status).fill }}" ></circle></svg>
                                                                </small>{{ status_config.get(task.status).text }}
                                                            </p>
                                                        </td>
                                                        <td>
                                                            <div class="d-flex justify-content-end align-items-center">
                                                                <form method="POST" action="/page/task/task_start">
                                                                        <input type="hidden" name="task_id" value="{{task.task_id}}">
                                                                        {% if task.status == 0 %}
                                                                            <button type="submit" class="btn btn-warning mt-2"><i class="ri-settings-4-fill pr-0">启动</i></button>
                                                                        {% elif task.status == 4 %}
                                                                            <button type="submit" class="btn btn-danger mt-2"><i class="ri-settings-4-fill pr-0" style="color:white">重启爬取</i></button>
                                                                        {% elif task.status == 5 %}
                                                                            <button type="submit" class="btn btn-danger mt-2"><i class="ri-settings-4-fill pr-0" style="color:white">重启分析</i></button>
                                                                        {% endif %}
                                                                            
                                                                </form>

                                                                {% if task.status == 3 %}
                                                                    <a class="" data-toggle="tooltip" data-placement="top" title="" data-original-title="View" href="/page/task/report?param={{ task.task_id }}">
                                                                        <button class="btn btn-success mt-2"><i class="" style="color:white">浏览</i></button>
                                                                    </a>
                                                                {% endif %}
                                                                {% if task.status in [2,3,5] %}
                                                                    <a class="" data-toggle="tooltip" data-placement="top" title="" data-original-title="View" href="/page/get_task_data?task_id={{ task.task_id }}">
                                                                        <button class="btn btn-success mt-2"><i class="" style="color:white">下载</i></button>
                                                                    </a>
                                                                {% endif %}
                                                                {% if task.status in [0, 4, 5] %}
                                                                        <button class="btn btn-primary mt-2 task-revise-link" data-task-id="{{ task.task_id }}"><i class="ri-settings-4-fill pr-0">修改</i></button>
                                                              
                                                                {% endif %}
                                                                {% if task.status in [0, 3, 4, 5] %}
                                                                    <form method="POST" action="/page/task/delete">
                                                                        <input type="hidden" name="task_id" value="{{task.task_id}}">
                                                                        <input type="hidden" name="from" value="crawl">
                                                                        <button class="btn btn-light mt-2"><i class="" style="color:white">删除</i></button>
                                                                    </form>   
                                                                {% endif %}  
                                                            </div>
                                                        </td>
                                                    </tr>
                                                {% endfor %}

                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

     <!-- 新增任务弹窗 -->
     <div id="taskModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h4 class="font-weight-bold">舆情任务配置</h4>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form class="task-form" id="task_create" method="POST" action="/page/task/create">
                    <!-- ✅ 导入全局配置按钮 -->
                    <div class="form-row">
                        <button type="button" class="btn btn-primary" id="importGlobalConfigBtn">导入全局配置</button>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="platform_name" class="form-label font-weight-bold text-muted text-uppercase">* 社交平台</label>
                            <select multiple class="form-control_window choicesjs" id="platform_name" name="platform_name" required>
                                <option>小红书</option>
                                <option>知乎</option>
                                <option>哔哩哔哩</option>
                                <option>微博</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <!-- 动态显示的Cookies输入区域 -->
                        <div id="cookiesContainer" class="form-group">
                            <!-- 这里会根据选择动态插入Cookie输入框 -->
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="start_time" class="form-label font-weight-bold text-muted text-uppercase">评论开始时间</label>
                            <input type="date" class="form-control_window" id="start_time" name="start_time">
                        </div>
                        <div class="form-group">
                            <label for="end_time" class="form-label font-weight-bold text-muted text-uppercase">评论结束时间</label>
                            <input type="date" class="form-control_window" id="end_time" name="end_time">
                        </div>                                
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="agency_name" class="form-label font-weight-bold text-muted text-uppercase">医疗机构全称</label>
                            <input type="text" class="form-control_window" id="agency_name" name="agency_name" placeholder="请输入医疗机构全称">
                        </div>
                        <div class="form-group">
                            <label for="other_names" class="form-label font-weight-bold text-muted text-uppercase">医疗机构简称/别名</label>
                            <input type="text" class="form-control_window" id="other_names" name="other_names" placeholder="请输入医疗机构简称/别名，若有多个请用///进行分隔">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="max_note" class="form-label font-weight-bold text-muted text-uppercase">每个平台最大爬取帖子数</label>
                            <input type="number" class="form-control_window" id="max_note" name="max_note" placeholder="请输入1-1000之间的整数">
                        </div>

                        <div class="form-group">
                            <label for="max_comment" class="form-label font-weight-bold text-muted text-uppercase">每个帖子最大爬取评论数</label>
                            <input type="number" class="form-control_window" id="max_comment" name="max_comment" placeholder="请输入1-500之间的整数">
                        </div>
                    </div>

                    <div class="form-row">
                        <label for="if_level" class="form-label font-weight-bold text-muted text-uppercase">是否爬取二级评论</label>
                        <select class="form-control" id="if_level" name="if_level">
                            <option value="" selected disabled>请选择</option>
                            <option>否</option>
                            <option>是</option>
                             </select>
                    </div>                    

                    <div class="form-row">
                        <div class="form-group">
                            <label for="gpu" class="form-label font-weight-bold text-muted text-uppercase">运行GPU</label>
                            <input type="text" class="form-control_window" id="gpu" name="gpu" placeholder="将gpu编号用英文逗号,进行分隔">        
                        </div>
                        <div class="form-group">
                            <label for="batch_size" class="form-label font-weight-bold text-muted text-uppercase">运行批量大小</label>
                            <input type="text" class="form-control_window" id="batch_size" name="batch_size" placeholder="请输入推理批量大小">        
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary cancel-btn">取消</button>
                        <button type="submit" class="btn btn-primary">提交</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Dark overlay background -->
    <div id="taskModal1" class="modal-overlay">
        <!-- Modal container centered -->
        <div class="modal-container">
            <div class="modal-header">
                <h4 id="update_head" class="font-weight-bold">任务配置修改</h4>
                <button class="close-modal1">&times;</button>
            </div>
            <div class="modal-body">
                <form class="task-form" method="POST" id="task_update" action="/page/task/update">  
                    <input type="hidden" name="task_id_update" id="task_id_update" value="">        


                    <div class="form-row">
                        <div class="form-group">
                            <label for="platform_name1" class="form-label font-weight-bold text-muted text-uppercase">* 社交平台</label>
                            <select multiple class="form-control_window choicesjs" id="platform_name1" name="platform_name1">
                                <option>小红书</option>
                                <option>知乎</option>
                                <option>哔哩哔哩</option>
                                <option>微博</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div id="cookiesContainer1" class="form-group">
                            
                        </div>
                    </div>
 

                    <div class="form-row">
                        <div class="form-group">
                            <label for="start_time1" class="form-label font-weight-bold text-muted text-uppercase">评论开始时间</label>
                            <input type="date" class="form-control_window" id="start_time1" name="start_time1">
                        </div>
                        <div class="form-group">
                            <label for="end_time1" class="form-label font-weight-bold text-muted text-uppercase">评论结束时间</label>
                            <input type="date" class="form-control_window" id="end_time1" name="end_time1">
                        </div>                                
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="agency_name1" class="form-label font-weight-bold text-muted text-uppercase">* 医疗机构全称</label>
                            <input type="text" class="form-control_window" id="agency_name1" name="agency_name1" 
                                    placeholder="请输入医疗机构全称">
                        </div>
                        <div class="form-group">
                            <label for="other_names1" class="form-label font-weight-bold text-muted text-uppercase">医疗机构简称/别名</label>
                            <input type="text" class="form-control_window" id="other_names1" name="other_names1" 
                                    placeholder="请输入医疗机构简称/别名，若有多个请用///进行分隔">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="max_note1" class="form-label font-weight-bold text-muted text-uppercase">每个平台最大爬取帖子数</label>
                            <input type="number" class="form-control_window" id="max_note1" name="max_note1" placeholder="请输入1-1000之间的整数">
                        </div>

                        <div class="form-group">
                            <label for="max_comment1" class="form-label font-weight-bold text-muted text-uppercase">每个帖子最大爬取评论数</label>
                            <input type="number" class="form-control_window" id="max_comment1" name="max_comment1" 
                            placeholder="请输入1-500之间的整数">
                        </div>
                    </div>

                    <div class="form-row">
                        <label for="if_level1" class="form-label font-weight-bold text-muted text-uppercase">是否爬取二级评论</label>
                        <select class="form-control" id="if_level1" name="if_level1">
                            <option value="" selected disabled>请选择</option>
                            <option>否</option>
                            <option>是</option>
                                </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="gpu1" class="form-label font-weight-bold text-muted text-uppercase">运行GPU</label>
                            <input type="text" class="form-control_window" id="gpu1" name="gpu1" 
                                    placeholder="将gpu编号用英文逗号,进行分隔">        
                        </div>
                        <div class="form-group">
                            <label for="batch_size1" class="form-label font-weight-bold text-muted text-uppercase">推理批量大小</label>
                            <input type="text" class="form-control_window" id="batch_size1" name="batch_size1" placeholder="请输入推理批量大小">        
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary cancel-btn1">取消</button>
                        <button type="submit" class="btn btn-primary">提交</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
// 弹窗控制逻辑
const modal = document.getElementById('taskModal');
const newTaskBtn = document.getElementById('newTaskBtn');
const closeModal = document.querySelector('.close-modal');
const cancelBtn = document.querySelector('.cancel-btn');

newTaskBtn.addEventListener('click', () => {
    modal.style.display = 'flex';
});

closeModal.addEventListener('click', () => {
    modal.style.display = 'none';
});

cancelBtn.addEventListener('click', () => {
    modal.style.display = 'none';
});



// 平台选择变化时动态显示对应的Cookies输入框
const platformSelect = document.getElementById('platform_name');
const cookiesContainer = document.getElementById('cookiesContainer');

// 平台与Cookie字段的映射
const platformCookiesMap = {
    '小红书': { name: 'cookies_xhs', placeholder: '小红书用户Cookies' },
    '知乎': { name: 'cookies_zhihu', placeholder: '知乎用户Cookies' },
    '哔哩哔哩': { name: 'cookies_bili', placeholder: '哔哩哔哩用户Cookies' },
    '微博': { name: 'cookies_wb', placeholder: '微博用户Cookies' }
};

// 监听平台选择变化
platformSelect.addEventListener('change', function() {
    updateCookieInputs();
});

// 初始化时也调用一次
updateCookieInputs();

function updateCookieInputs() {
    // 清空容器
    cookiesContainer.innerHTML = '';
    
    // 获取选中的平台
    const selectedPlatforms = Array.from(platformSelect.selectedOptions).map(opt => opt.value);
    
    // 如果没有选择任何平台，不显示任何输入框
    if (selectedPlatforms.length === 0) {
        return;
    }
    
    // 创建label
    const label = document.createElement('label');
    label.textContent = '平台Cookies';
    label.className = "form-label font-weight-bold text-muted text-uppercase"
    cookiesContainer.appendChild(label);
    
    // 为每个选中的平台创建输入框
    selectedPlatforms.forEach(platform => {
        if (platformCookiesMap[platform]) {
            const inputGroup = document.createElement('div');
            inputGroup.className = 'cookie-input-group';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.value= ''
            input.className = 'form-control_window';
            input.name = platformCookiesMap[platform].name;
            input.placeholder = platformCookiesMap[platform].placeholder;
            
            inputGroup.appendChild(input);
            cookiesContainer.appendChild(inputGroup);
        }
    });
}


// 处理表单提交
document.getElementById('task_create').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const selectedPlatforms = Array.from(document.getElementById('platform_name').selectedOptions);
    if (selectedPlatforms.length === 0) {
        e.preventDefault();
        showErrorToast("请至少选择一个平台");
        return false;
    }

    if(document.getElementById('agency_name').value === ""){
        e.preventDefault();
        showErrorToast("请输入医疗机构全称");
        return false;
    }
    try {
        const response = await fetch(this.action, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            window.location.href = result.redirect;
        } else {
            showErrorToast(result.message);
        }
    } catch (error) {
        showErrorToast('网络错误，请稍后再试');
    }
});

document.getElementById('importGlobalConfigBtn').addEventListener('click', async function () {
    try {
        const response = await fetch('/page/global_config_import'); 
        const data = await response.json();

        if (data.success) {
            // 自动填入各个字段
            document.getElementById('agency_name').value = data.config.agency_name || '';
            document.getElementById('other_names').value = data.config.other_names || '';
            document.getElementById('batch_size').value = data.config.batch_size || '';
            document.getElementById('max_note').value = data.config.max_note || '';
            document.getElementById('max_comment').value = data.config.max_comment || '';
            if(data.config.if_level == 0){
                document.getElementById('if_level').value = '否'
            }else{
                document.getElementById('if_level').value = '是'
            }
            document.getElementById('gpu').value = data.config.gpu || '';

            // 触发一次平台下拉框变更逻辑（更新cookie输入框）
            updateCookieInputs();
        } else {
            showErrorToast(data.message || '导入失败');
        }
    } catch (error) {
        showErrorToast('请求失败，请稍后重试');
    }
});


</script>









<script>
    // 弹窗控制逻辑
    const modal1 = document.getElementById('taskModal1');
    const closeModal1 = document.querySelector('.close-modal1');
    const cancelBtn1 = document.querySelector('.cancel-btn1');
      
    closeModal1.addEventListener('click', () => {
        modal1.style.display = 'none';
    });
    
    cancelBtn1.addEventListener('click', () => {
        modal1.style.display = 'none';
    });
    
    
    // 平台选择变化时动态显示对应的Cookies输入框
    const platformSelect1 = document.getElementById('platform_name1');
    const cookiesContainer1 = document.getElementById('cookiesContainer1');
    
    
    // 监听平台选择变化
    platformSelect1.addEventListener('change', function() {
        updateCookieInputs1();
    });
    
    // 初始化时也调用一次
    updateCookieInputs1();
    
    function updateCookieInputs1() {
        // 清空容器
        cookiesContainer1.innerHTML = '';
        
        // 获取选中的平台
        const selectedPlatforms1 = Array.from(platformSelect1.selectedOptions).map(opt => opt.value);
        
        // 如果没有选择任何平台，不显示任何输入框
        if (selectedPlatforms1.length === 0) {
            return;
        }
        
        // 创建label
        const label1 = document.createElement('label');
        label1.textContent = '平台Cookies';
        label1.className = "form-label font-weight-bold text-muted text-uppercase"
        cookiesContainer1.appendChild(label1);
        
        // 为每个选中的平台创建输入框
        selectedPlatforms1.forEach(platform => {
            if (platformCookiesMap[platform]) {
                const inputGroup1 = document.createElement('div');
                inputGroup1.className = 'cookie-input-group';
                
                const input1 = document.createElement('input');
                input1.type = 'text';
                input1.value= ''
                input1.className = 'form-control_window';
                input1.name = platformCookiesMap[platform].name;
                input1.placeholder = platformCookiesMap[platform].placeholder;
                
                inputGroup1.appendChild(input1);
                cookiesContainer1.appendChild(inputGroup1);
            }
        });
    }
    
    
    // 处理表单提交
    document.getElementById('task_update').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData1 = new FormData(this);
        const selectedPlatforms  = Array.from(document.getElementById('platform_name1').selectedOptions);
        if (selectedPlatforms.length === 0) {
            e.preventDefault();
            showErrorToast("请至少选择一个平台");
            return false;
        }
        if(document.getElementById('agency_name1').value === ""){
            e.preventDefault();
            showErrorToast("请输入医疗机构全称");
            return false;
        }
        try {
            const response1 = await fetch(this.action, {
                method: 'POST',
                body: formData1
            });
            const result1 = await response1.json();
            if (result1.success) {
                window.location.href = result1.redirect;
            } else {
                showErrorToast(result1.message);
            }
        } catch (error) {
            showErrorToast('网络错误，请稍后再试');
        }
    });
    

document.querySelectorAll('.task-revise-link').forEach(link => {
    link.addEventListener('click', async function(event) {
        event.preventDefault();
        const taskId = this.getAttribute('data-task-id');
        document.getElementById('update_head').innerHTML= `任务${taskId}配置修改`;
        document.getElementById('task_id_update').value = taskId;

        try{
            const response1 = await fetch(`/page/task/update?task_id=${taskId}`); 
            const data1 = await response1.json();      
            console.log(data1);
            if (data1.success) {
                // 自动填入各个字段
                document.getElementById('agency_name1').value = data1.task_info.agency_name || '';
                document.getElementById('other_names1').value = data1.task_info.other_names || '';
                document.getElementById('batch_size1').value = data1.task_info.batch_size || '';
                document.getElementById('max_note1').value = data1.task_info.max_note || '';
                document.getElementById('max_comment1').value = data1.task_info.max_comment || '';
                document.getElementById('start_time1').value = data1.task_info.start_time || '';
                document.getElementById('end_time1').value = data1.task_info.end_time || '';
                if(data1.task_info.if_level == 0){
                    document.getElementById('if_level1').value = '否'
                }else{
                    document.getElementById('if_level1').value = '是'
                }
                document.getElementById('gpu1').value = data1.task_info.gpu || '';
                // 显示模态框
                document.getElementById('taskModal1').style.display = 'flex';
            } else {
                showErrorToast(data.message || '获取任务信息失败');
            }
        }catch(error){
            showErrorToast('请求失败，请稍后重试');
        }
    })
});

</script>
{% endblock %}

