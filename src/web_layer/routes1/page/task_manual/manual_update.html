{% extends 'base_page.html' %}
{% block title %}
    导入分析-更新任务
{% endblock %}


{% block content %}
    <!-- Dark overlay background -->
    <div class="modal-overlay" style="display: flex;">
        <!-- Modal container centered -->
        <div class="modal-container" style="max-width: 900px; width: 90%;">
            <div class="modal-header">
                <h4 class="font-weight-bold">任务{{ task_id }}配置修改</h4>
                <a href="/page/manual/home" class="close-modal">&times;</a>
            </div>
            <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
                <form id="manualForm" class="task-form" method="POST" action="/page/manual/update" enctype="multipart/form-data">
                    <input type="hidden" name="task_id" value="{{ task_id }}">
                    
                    <div class="form-row" >
                        <label for="input_format" class="form-label font-weight-bold text-muted text-uppercase">*导入格式</label>
                        <select class="form-control" id="input_format" name="input_format" required >
                            <option value="" selected disabled>请选择</option>
                            <option {% if task.input_format == "txt" %}selected{% endif %}>txt</option>
                            <option {% if task.input_format == "xlsx" %}selected{% endif %}>xlsx</option>
                             </select>
                    </div> 
                    <div class="form-row" id="sep_row" style="display: none;">
                        <div class="form-group">
                            <label for="sep" class="form-label font-weight-bold text-muted text-uppercase">分割符</label>
                            <input type="text" class="form-control_window" id="sep" name="sep" placeholder="若不输入,则按行分割且不允许空行" value="{{task.sep}}">
                        </div>
                    </div>
                    <div class="form-row" id="xlsx_row" style="display: none;">
                        <div class="form-group">
                            <label for="col" class="form-label font-weight-bold text-muted text-uppercase">文本所在列数</label>
                            <input type="text" class="form-control_window" id="col" name="col" placeholder="请输入>=1的整数；若不输入，默认为舆情任务数据的表格格式" value="{{task.col}}">
                        </div>
                        <div class="form-group">
                            <label for="row" class="form-label font-weight-bold text-muted text-uppercase">文本开始行数</label>
                            <input type="text" class="form-control_window" id="row" name="row" placeholder="请输入>=1的整数；若不输入，默认为舆情任务数据的表格格式" value="{{task.row}}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="upload_data" name="upload_data" required>
                                <label class="custom-file-label font-weight-bold text-muted" for="upload_data">* 请导入txt文件或xlsx文件</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="agency_name" class="form-label font-weight-bold text-muted text-uppercase">* 医疗机构全称</label>
                            <input type="text" class="form-control_window" id="agency_name" name="agency_name" value="{{ task.agency_name }}" placeholder="请输入医疗机构全称" required>
                        </div>
                        <div class="form-group">
                            <label for="other_names" class="form-label font-weight-bold text-muted text-uppercase">医疗机构简称/别名</label>
                            <input type="text" class="form-control_window" id="other_names" name="other_names" placeholder="请输入医疗机构简称/别名，若有多个请用///进行分隔" value="{{ task.other_names }}" >
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="gpu" class="form-label font-weight-bold text-muted text-uppercase">运行GPU</label>
                            <input type="text" class="form-control_window" id="gpu" name="gpu" value="{{ task.gpu }}" placeholder="将gpu编号用英文逗号,进行分隔">        
                        </div>
                        <div class="form-group">
                            <label for="batch_size" class="form-label font-weight-bold text-muted text-uppercase">推理批量大小</label>
                            <input type="text" class="form-control_window" id="batch_size" name="batch_size" placeholder="请输入推理批量大小" value="{{ task.batch_size }}">        
                        </div>
                    </div>

                    <div class="form-actions">
                        <a href="/page/manual/home" class="btn btn-secondary">取消</a>
                        <button type="submit" class="btn btn-primary">提交</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 新增错误提示容器 -->
<div id="errorToast" class="error-toast" style="display: none;">
    <div>
        <i class="fas fa-exclamation-circle"></i>
        <span id="errorMessage"></span>
    </div>
    <div class="error-toast-close" onclick="hideErrorToast()">
        <i class="fas fa-times"></i>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // 弹窗控制逻辑
    const modal = document.getElementById('taskModal');
    const newTaskBtn = document.getElementById('newTaskBtn');
    const closeModal = document.querySelector('.close-modal');
    const cancelBtn = document.querySelector('.cancel-btn');

    newTaskBtn.addEventListener('click', () => {
        modal.style.display = 'flex';
    });

    closeModal.addEventListener('click', () => {
        modal.style.display = 'none';
    });

    cancelBtn.addEventListener('click', () => {
        modal.style.display = 'none';
    });

    // 点击弹窗外部关闭
    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });

</script>

<!-- error script -->
<script>

    // 显示错误提示
    function showErrorToast(message) {
        const toast = document.getElementById('errorToast');
        const errorMessage = document.getElementById('errorMessage');
        
        errorMessage.textContent = message;
        toast.style.display = 'flex';
        
        // 3秒后自动隐藏
        setTimeout(() => {
            toast.style.display = 'none';
        }, 3000);
    }

    // 隐藏错误提示
    function hideErrorToast() {
        document.getElementById('errorToast').style.display = 'none';
    }

    // 处理表单提交
    document.getElementById('manualForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        try {
            const response = await fetch(this.action, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            //console.log(result)
            
            if (result.success) {
                window.location.href = result.redirect;
            } else {
                //console.log(result)
                showErrorToast(result.message);
            }
        } catch (error) {
            showErrorToast('网络错误，请稍后再试');
        }
    });

inputFormat = document.getElementById("input_format")
updateSep();
updateColrow();
inputFormat.addEventListener("change", function () {
    updateSep();
});
inputFormat.addEventListener("change", function () {
    updateColrow();
});
function updateSep(){
    const sepRow = document.getElementById("sep_row");
    if (inputFormat.value === "txt") {
        sepRow.style.display = "block";
    } else {
        sepRow.style.display = "none";
        sep.value=""
    }
}
function updateColrow(){
    const xlsxRow = document.getElementById("xlsx_row");
    if (inputFormat.value === "xlsx") {
        xlsxRow.style.display = "block";
    } else {
        xlsxRow.style.display = "none";
        row.value=""
        col.value=""
    }
}
</script>
{% endblock %}